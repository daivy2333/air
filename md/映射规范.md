附录A：可视化映射规范

A.1 核心原则

A.1.1 一一映射原则

• 每个DependencyEdge对应一条图边

• 不得合并、省略或推断依赖边

• 图是PIR的精确投影，不是解释

A.1.2 节点类型限制

仅允许三类节点：

节点类型 来源 限制

Unit节点 <units> 必须对应原始unit

Symbol节点 <symbols> 仅当依赖指向symbol时生成

External节点 <dependency-pool>中ext类型 必须对应原始external引用

禁止行为：
• ❌ 推断模块/包节点

• ❌ 推断调用图节点

• ❌ 自动分组

A.2 抽象图模型

所有可视化后端必须使用统一抽象模型：
@dataclass(frozen=True)
class VisualNode:
    """可视化节点"""
    id: str          # 唯一标识符
    kind: str        # unit | symbol | external
    label: str       # 显示标签
    
    @classmethod
    def from_unit(cls, unit: Unit) -> 'VisualNode':
        return cls(f"u{unit.id}", "unit", str(unit.path))
    
    @classmethod
    def from_symbol(cls, symbol: Symbol) -> 'VisualNode':
        return cls(f"{symbol.unit_id}#{symbol.name}", "symbol", symbol.name)
    
    @classmethod
    def from_external(cls, ext_id: str, label: str) -> 'VisualNode':
        return cls(f"ext:{ext_id}", "external", label)

@dataclass(frozen=True)
class VisualEdge:
    """可视化边"""
    src_id: str      # 源节点ID
    dst_id: str      # 目标节点ID
    dep_kind: str    # import | refs | call | include


A.3 节点映射规范

A.3.1 Unit节点

• ID: uX (X为unit ID)

• 标签: <unit.path>

• 类型: unit

A.3.2 Symbol节点

• ID: uX#SymbolName

• 标签: SymbolName

• 类型: symbol

约束: Symbol节点仅当依赖指向symbol时生成

A.3.3 External节点

• ID: ext:<原始ID> (如ext:stdlib:py)

• 标签: <原始标签>

• 类型: external

ID转义规则: :替换为_，如stdlib:py → ext:stdlib_py

A.4 边映射规范

A.4.1 依赖类型语义

dep_kind 含义 禁止解释为

import 文件/模块级依赖 调用关系

refs 泛引用关系 调用关系

call 显式函数调用 模块导入

include 头文件包含 模块导入

A.4.2 边类型检测规则

def detect_edge_type(dep: str) -> str:
    """检测依赖边类型"""
    if dep.startswith("import:"):
        return "import"
    elif dep.startswith("sym:"):
        return "refs"  # 符号引用视为refs
    elif dep.startswith("ref:"):
        return "refs"
    elif dep.startswith("ext:"):
        return "import"  # 外部依赖视为import
    else:
        return "refs"  # 默认为refs


A.5 Graphviz DOT映射

A.5.1 全局样式

digraph PIR {
    rankdir=LR;                     # 从左到右布局
    node [fontname="monospace"];    # 等宽字体
    edge [fontname="monospace"];    # 等宽字体
    fontname="monospace";
}


A.5.2 节点样式映射

节点类型 shape style color

unit box filled,rounded #cce5ff

symbol ellipse filled,dashed #d4edda

external octagon filled,dotted #f8d7da
A.5.3 边样式映射
dep_kind style color label

import solid #007bff import

refs solid #6c757d refs

call dashed #28a745 call

include dotted #ffc107 include

A.5.4 DOT生成示例

digraph PIR {
    rankdir=LR;
    node [fontname="monospace"];
    edge [fontname="monospace"];
    
    // Unit节点
    u0 [label="pirgen.py", shape=box, style=filled, fillcolor="#cce5ff"];
    u2 [label="core/pir_builder.py", shape=box, style=filled, fillcolor="#cce5ff"];
    
    // Symbol节点
    u2_PIRBuilder [label="PIRBuilder", shape=ellipse, style="filled,dashed", fillcolor="#d4edda"];
    
    // External节点
    ext_stdlib_py [label="stdlib:py", shape=octagon, style="filled,dotted", fillcolor="#f8d7da"];
    
    // 边
    u0 -> u2 [label="import", style=solid, color="#007bff"];
    u0 -> u2_PIRBuilder [label="refs", style=solid, color="#6c757d"];
    u0 -> ext_stdlib_py [label="import", style=solid, color="#007bff"];
}


A.6 PlantUML映射

A.6.1 全局设置

@startuml
left to right direction
skinparam monochrome true
skinparam shadowing false
skinparam nodesep 10
skinparam ranksep 20
@enduml


A.6.2 节点映射

节点类型 PlantUML元素 样式

unit component #cce5ff

symbol interface #d4edda

external node #f8d7da
A.6.3 边映射
dep_kind PlantUML箭头 样式

import --> #007bff

refs --> #6c757d

call ..> #28a745

include ..|> #ffc107

A.6.4 PlantUML生成示例

@startuml
left to right direction

' Unit节点
component "pirgen.py" as u0 #cce5ff
component "core/pir_builder.py" as u2 #cce5ff

' Symbol节点
interface "PIRBuilder" as u2_PIRBuilder #d4edda

' External节点
node "stdlib:py" as ext_stdlib_py #f8d7da

' 边
u0 --> u2 : import
u0 --> u2_PIRBuilder : refs
u0 --> ext_stdlib_py : import

@enduml


A.7 确定性规则

A.7.1 输出顺序

1. 节点顺序：
   • Units按ID升序 (u0, u1, u2...)

   • Symbols按在PIR中声明顺序

   • Externals按ID升序 (d0, d1, d2...)

2. 边顺序：
   • 按<dependencies>区块中声明顺序

   • 同一单元的多行按出现顺序

A.7.2 标签生成规则

节点标签必须保持原始格式：
• Unit: 完整unit.path

• Symbol: 原始符号名

• External: 原始external字符串

A.8 验证要求

A.8.1 节点验证

def validate_nodes(graph: Graph, pir: PIR) -> List[str]:
    """验证节点一致性"""
    errors = []
    
    # 1. 检查Unit节点数量
    graph_unit_nodes = [n for n in graph.nodes if n.kind == "unit"]
    if len(graph_unit_nodes) != len(pir.units):
        errors.append(f"Unit节点数量不匹配: 图={len(graph_unit_nodes)}, PIR={len(pir.units)}")
    
    # 2. 检查每个Unit节点都存在
    for unit in pir.units:
        node_id = f"u{unit.id}"
        if node_id not in graph.node_ids:
            errors.append(f"缺失Unit节点: {node_id}")
    
    # 3. 检查External节点
    graph_ext_nodes = [n for n in graph.nodes if n.kind == "external"]
    pir_ext_deps = [d for d in pir.dependency_pool if d.startswith("ext:")]
    if len(graph_ext_nodes) != len(pir_ext_deps):
        errors.append(f"External节点数量不匹配")
    
    return errors


A.8.2 边验证

def validate_edges(graph: Graph, pir: PIR) -> List[str]:
    """验证边一致性"""
    errors = []
    
    # 1. 检查边数量
    expanded_edges = expand_dependencies(pir.dependencies, pir.dependency_pool)
    if len(graph.edges) != len(expanded_edges):
        errors.append(f"边数量不匹配: 图={len(graph.edges)}, PIR={len(expanded_edges)}")
    
    # 2. 检查每条边都有对应依赖
    for edge in graph.edges:
        if not has_corresponding_dependency(edge, pir):
            errors.append(f"图中存在未声明的边: {edge.src_id} -> {edge.dst_id}")
    
    return errors


A.9 实现一致性要求

A.9.1 三端一致性

对于同一PIR输入，必须保证：
1. 节点集合相同：Mermaid/Graphviz/PlantUML的节点ID集合必须相同
2. 边集合相同：源-目标-类型三元组必须相同
3. 标签相同：对应节点的标签文本必须相同

A.9.2 可验证的确定性

def test_determinism(pir_content: str):
    """测试可视化确定性"""
    # 解析PIR
    pir = parse_pir(pir_content)
    
    # 生成三种可视化
    mermaid = generate_mermaid(pir)
    dot = generate_dot(pir)
    plantuml = generate_plantuml(pir)
    
    # 提取节点和边进行比较
    mermaid_nodes = extract_nodes(mermaid)
    dot_nodes = extract_nodes(dot)
    plantuml_nodes = extract_nodes(plantuml)
    
    # 验证节点集合相同
    assert set(mermaid_nodes) == set(dot_nodes) == set(plantuml_nodes)
    
    # 验证边集合相同
    mermaid_edges = extract_edges(mermaid)
    dot_edges = extract_edges(dot)
    plantuml_edges = extract_edges(plantuml)
    
    assert set(mermaid_edges) == set(dot_edges) == set(plantuml_edges)


A.10 禁止行为清单

1. 节点相关禁止：
   • ❌ 自动分组或聚类unit节点

   • ❌ 基于module创建虚拟节点

   • ❌ 省略未连接的节点

   • ❌ 重命名节点标签

2. 边相关禁止：
   • ❌ 合并重复边

   • ❌ 推断传递依赖

   • ❌ 省略间接依赖

   • ❌ 改变依赖类型

3. 布局相关禁止：
   • ❌ 基于语义重新排列节点

   • ❌ 自动调整层级关系

   • ❌ 隐藏特定类型的节点

   • ❌ 添加未声明的边类型

A.11 设计哲学

本可视化映射规范遵循投影而非解释原则：
• 图是PIR关系的忠实投影

• 不添加未在PIR中声明的信息

• 不删除已在PIR中声明的信息

• 不改变PIR中关系的语义

可视化目标是辅助理解项目结构，而不是推断项目语义。